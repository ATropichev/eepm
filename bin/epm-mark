#!/bin/sh
#
# Copyright (C) 2020, 2022  Etersoft
# Copyright (C) 2020, 2022  Vitaly Lipatov <lav@etersoft.ru>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
#

# TODO: move to a common place and use
__is_wildcard()
{
	echo "$1" | grep -q "[*?]"
}

__alt_mark_hold_package()
{
		local pkg="$1"
		showcmd "echo \"RPM::Hold {\"^$pkg\";};\" > /etc/apt/apt.conf.d/hold-$pkg.conf"
		echo "RPM::Hold {\"^$pkg\";};" | sudorun tee "/etc/apt/apt.conf.d/hold-$pkg.conf" >/dev/null
}

__alt_test_glob()
{
	echo "$*" | grep -q "\.[*?]" && warning "Only glob symbols * and ? are supported. Don't use regexp here!"
}

__alt_mark_hold()
{
	# TODO: do more long checking via apt
	local pkg
	local i
	__alt_test_glob "$*"
	for i in "$@" ; do
		if __is_wildcard "$i" ; then
			local pkglist
			pkglist="$(epm qp --short "^$i")" || continue
			for pkg in $pkglist ; do
				__alt_mark_hold_package $pkg
			done
			return
		else
			pkg="$(epm query --short "$i")" || continue
		fi
		__alt_mark_hold_package $pkg
	done
}

__alt_mark_unhold()
{
	# TODO: do more long checking via apt
	local pkg
	local i
	__alt_test_glob "$*"
	for i in "$@" ; do
		pkg="$(epm query --short "$i")" || pkg="$i"
		sudocmd rm -fv /etc/apt/apt.conf.d/hold-$pkg.conf
	done
}

__alt_mark_showhold()
{
	grep -h "RPM::Hold" /etc/apt/apt.conf.d/hold-*.conf 2>/dev/null | sed -e 's|RPM::Hold {"^\(.*\)";};|\1|'
}

epm_mark()
{

case $PMTYPE in
	apt-rpm)
		if [ "$1" = "hold" ] ; then
			shift
			__alt_mark_hold "$@"
			exit
		fi
		if [ "$1" = "unhold" ] ; then
			shift
			__alt_mark_unhold "$@"
			exit
		fi
		if [ "$1" = "showhold" ] ; then
			shift
			__alt_mark_showhold "$@"
			exit
		fi
		sudocmd apt-mark "$@"
		if [ "$1" = "" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ] ; then
			echo
			echo "EPM additionals: "
			echo "	hold pkg1 [pkg2 ...] - hold the given package(s)"
			echo "	unhold pkg1 [pkg2 ...] - unhold the given package(s)"
		fi
		;;
	apt-dpkg)
		sudocmd apt-mark "$@"
		;;
	*)
		fatal "Have no suitable command for $PMTYPE"
		;;
esac

}
