#!/bin/sh
#
# Copyright (C) 2012  Etersoft
# Copyright (C) 2012  Vitaly Lipatov <lav@etersoft.ru>
#
# This file is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.
#

# HACK
#ETERBUILDBIN=/usr/bin
# FIXME
#. /usr/share/eterbuild/eterbuild
#load_mod rpm git buildsrpm

PROGDIR=$(dirname $0)

load_helper()
{
    [ -r "$PROGDIR/$1" ] || fatal "Have no $PROGDIR/$1 helper file"
    . $PROGDIR/$1
}

load_helper epm-sh-functions

# set SUDO not for root user
SUDO="sudo"
[ -n "$UID" ] || UID=`id -u`
if [ $UID = "0" ]; then
    SUDO=""
fi


#############################

phelp()
{
	echo "$Descr
$Usage

   -i|install    	install package(s)
   -e|remove     	remove package(s)
   -s|search     	search in remote and local package base
   -qa|list|packages	list of installed package(s)
   -qf			query package(s) owning file
   -q			check presence of package(s)
 Options:
   -v|--verbose  verbose mode
   --auto        non interactive mode
   -h|--help     this help
"
}

Usage="Usage: epm [options] <command> [package name(s), package files]..."
Descr="epm - EPM package manager"

verbose=
non_interactive=
epm_cmd=
pkg_files=
pkg_names=

progname="${0##*/}"
case $progname in
    epmi)
        epm_cmd=install
        ;;
    epme)
        epm_cmd=remove
        ;;
    epms)
        epm_cmd=search
        ;;
    epmqf)
        epm_cmd=query_file
        ;;
    epm)
        ;;
    *)
        fatal "Unknown command: $progname"
        ;;
esac

for opt in "$@" ; do
    case $opt in
    -h|--help|help)
        phelp; exit 0
        ;;
    -v|--verbose)
        verbose=1
        ;;
    --auto)
        non_interactive=1
        ;;
    -i|install)
        epm_cmd=install
        ;;
    -e|remove)
        epm_cmd=remove
        ;;
    dist-upgrade|upgrade)
        epm_cmd=upgrade
        ;;
    -s|search)
        epm_cmd=search
        ;;
    -q|installed)
        epm_cmd=query
        ;;
    -qf)
        epm_cmd=query_file
        ;;
    -qa|list|packages)
        epm_cmd=packages
        ;;
    *)
        if [ -f "$opt" ] ; then
            pkg_files="$pkgfiles $opt"
        else
            pkg_names="$pkgnames $opt"
        fi
        ;;
    esac
done

pkg_files=$(strip_spaces "$pkg_files")
pkg_names=$(strip_spaces "$pkg_names")

pkg_filenames=$(strip_spaces "$pkg_files $pkg_names")

echover "pkg_files=$pkg_files"
echover "pkg_names=$pkg_names"

# Fill for use: PMTYPE, DISTRNAME, DISTRVERSION, PKGFORMAT, PKGVENDOR, RPMVENDOR
DISTRVENDOR=$PROGDIR/distr_info
[ -n "$DISTRNAME" ] || DISTRNAME=$($DISTRVENDOR -d)
[ -n "$DISTRVERSION" ] || DISTRVERSION=$($DISTRVENDOR -v)
set_target_pkg_env
set_pm_type

# Run helper for command
[ -n "$epm_cmd" ] || fatal "Run without any command"
load_helper epm-$epm_cmd
epm_$epm_cmd || fatal ""
